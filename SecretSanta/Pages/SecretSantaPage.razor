@using SecretSanta.Domain
@using SecretSanta.Domain.State
@inject UserSantaEvents SantaEvents
@inject NavigationManager Navigation
@implements IDisposable
@page "/"

<div class="animate-in">
    @if (!SantaEvents.Events.Any())
    {
        <div class="section-box" style="text-align: center; padding: 2rem;">
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;" class="text-muted">No events yet!</p>
            <p>Create your first Secret Santa event to get started.</p>
        </div>
    }
    else
    {
        <h2 class="section-title">Your Events</h2>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
            @foreach (var santaEvent in SantaEvents.Events.OrderBy(x => x.Archived))
            {
                <div class="event-card @(santaEvent.Archived ? "archived" : "")" @onclick="() => Select(santaEvent)">
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <span class="event-card-title">@santaEvent.Name</span>
                        @if(santaEvent.Archived)
                        {
                            <span class="badge badge-archived">archived</span>
                        }
                    </div>
                    <p class="event-card-meta">@santaEvent.TelegramUsers.Count() participants</p>
                </div>
            }
        </div>
    }

    <div style="margin-top: 2rem; display: flex; justify-content: center;">
        <NavLink href="NewEvent">
            <Button Size="ButtonSize.Large">Create New Event</Button>
        </NavLink>
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        SantaEvents.SantaEventsChanged += OnSantaChanged;
        base.OnInitialized();
    }

    private void OnSantaChanged(object? sender, EventArgs e)
    {
        StateHasChanged();
    }

    public void Dispose()
    {
        SantaEvents.SantaEventsChanged -= OnSantaChanged;
    }

    private void Select(SecretSantaEvent santaEvent)
    {
        Navigation.NavigateTo($"/{santaEvent.Uid}/selected");
    }
}
