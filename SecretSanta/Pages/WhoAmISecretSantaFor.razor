@page "/{Uid}/WhoAmISecretSantaFor"
@using SecretSanta.Domain.State
@using SecretSanta.Domain
@using System.Diagnostics.CodeAnalysis
@using Microsoft.Extensions.Localization
@implements IDisposable

@inject UserSantaEvents SantaEvents
@inject TelegramAuth Auth
@inject IStringLocalizer Localizer

@if (SantaEvent == null || Opponent == null)
{
    <div class="section-box animate-in" style="text-align: center; padding: 3rem 1.5rem;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üîç</div>
        <p style="font-size: 1.1rem;">@Localizer.GetString("EventNotFound")</p>
        <p class="text-muted" style="margin-top: 0.5rem;">Please log in with Telegram to see your match.</p>
    </div>
}
else
{
    <div class="animate-in">
        @if (SantaEvent.Archived)
        {
            <div style="background: var(--color-gold-light); border: 2px solid var(--color-gold); border-radius: 12px; padding: 1rem; text-align: center; margin-bottom: 1.5rem;">
                <p style="font-weight: 600; margin: 0;">@Localizer.GetString("EventArchived")</p>
            </div>
        }

        <h2 class="page-title">@SantaEvent.Name</h2>

        <!-- The Big Reveal -->
        <div class="section-box" style="text-align: center; padding: 2rem; margin-bottom: 1.5rem;">
            <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                <img class="reveal-present" src="img/present.png" alt="Present" style="width: 48px; height: auto;">
                <span style="font-size: 2rem;">üéÑ</span>
                <img class="reveal-present" src="img/present.png" alt="Present" style="width: 48px; height: auto; animation-delay: 0.5s;">
            </div>

            <p class="text-muted" style="margin-bottom: 0.5rem;">@Localizer.GetString("BuyPresentFor")</p>

            <div class="reveal-box" style="display: inline-block; margin-top: 0.5rem;">
                <p class="reveal-name">@Opponent.Name</p>
                <a class="member-username" style="font-size: 1.1rem;"
                   target="_blank"
                   href="https://t.me/@Opponent.TelegramLogin">
                    @@@Opponent.TelegramLogin
                </a>
            </div>
        </div>

        @if(TryGetPrice(out var price))
        {
            <div class="section-box" style="display: flex; align-items: center; justify-content: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                <span style="font-size: 1.5rem;">üí∞</span>
                <p style="margin: 0;">
                    @((MarkupString)Localizer.GetString("RecommendedMaxPriceIs").Value)
                    <strong>@price.Value @price.Currency</strong>
                </p>
            </div>
        }

        @if (SantaEvent.Archived)
        {
            <div style="background: var(--color-gold-light); border: 2px solid var(--color-gold); border-radius: 12px; padding: 1rem; text-align: center;">
                <p style="font-weight: 600; margin: 0;">@Localizer.GetString("EventArchived")</p>
            </div>
        }
    </div>
}

@code {

    [Parameter]
    public string Uid { get; set; }

    private bool TryGetPrice([NotNullWhen(true)] out MaxPrice? price)
    {
        price = null;
        return SantaEvent?.Metadata.TryGetPrice(out price) ?? false;
    }

    protected override void OnInitialized()
    {
        Auth.AuthChanged += OnAuthChanged;
        SantaEvents.SantaEventsChanged += OnSantaChanged;
        base.OnInitialized();
    }

    private void OnSantaChanged(object? sender, EventArgs e) => StateHasChanged();
    private void OnAuthChanged(object? sender, EventArgs args) => StateHasChanged();

    public void Dispose()
    {
        Auth.AuthChanged -= OnAuthChanged;
        SantaEvents.SantaEventsChanged -= OnSantaChanged;
    }

    SecretSantaEvent? SantaEvent => SantaEvents.Events.FirstOrDefault(e => e.Uid.Equals(Uid));
    SecretSantaMember? Opponent => SantaEvents.Events.FirstOrDefault(e => e.Uid.Equals(Uid))?.GetOpponentFor(Auth?.Login?.Login);
}
