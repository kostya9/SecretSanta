@page "/NewEvent"
@using SecretSanta.Domain
@using SecretSanta.Domain.Data
@using SecretSanta.Domain.State
@using System.Text.Json
@using System.Text.Json.Nodes

@inject NavigationManager Navigation
@inject UserSantaEvents SantaEvents
@inject Persistence Persistence
@inject TelegramAuth Auth

<div class="animate-in">
    <h2 class="page-title">Create New Event</h2>

    <!-- Event Details -->
    <div class="section-box" style="margin-bottom: 1.5rem;">
        <h3 class="section-title">Event Details</h3>

        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label class="form-label">Event Name</label>
                <input type="text"
                       class="input"
                       @bind-value="EventName"
                       @bind-value:event="oninput"
                       placeholder="e.g., Family Christmas 2024"/>
            </div>

            <div>
                <label class="form-label">Your Display Name</label>
                <input type="text"
                       class="input"
                       @bind-value="LoggedInName"
                       @bind-value:event="oninput"
                       placeholder="How others will see you"/>
            </div>
        </div>
    </div>

    <!-- Participants -->
    <div class="section-box" style="margin-bottom: 1.5rem;">
        <h3 class="section-title">Participants</h3>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem;">
            <!-- You card -->
            <div class="member-card member-card-highlight">
                <span class="badge badge-you" style="margin-bottom: 0.5rem; display: inline-block;">You</span>
                <p class="member-name">@(LoggedInName ?? "Your name")</p>
                <span class="member-username">@@@Auth.Login.Login</span>
            </div>

            @foreach (var member in _members)
            {
                <div class="member-card" style="position: relative;">
                    <p class="member-name">@member.Name</p>
                    <a class="member-username" target="_blank" href="https://t.me/@member.TelegramLogin">
                        @@@member.TelegramLogin
                    </a>
                    <button @onclick="() => RemoveMember(member)"
                            style="position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; cursor: pointer; color: var(--color-red); font-size: 1.25rem; line-height: 1; padding: 0.25rem;">
                        Ã—
                    </button>
                </div>
            }
        </div>

        <!-- Add member form -->
        <div class="card">
            <h4 style="font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 700; margin: 0 0 1rem 0;">Add Participant</h4>

            @if (_errorText != null)
            {
                <p class="text-error" style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(197, 75, 75, 0.1); border-radius: 8px;">
                    @_errorText
                </p>
            }

            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <input type="text"
                           class="input"
                           @bind-value="NewMemberName"
                           @bind-value:event="oninput"
                           placeholder="Name"/>
                    <input list="tg-login"
                           type="text"
                           class="input"
                           @bind="NewMemberLogin"
                           @oninput="UpdateAutocomplete"
                           placeholder="Telegram username"/>
                    <datalist id="tg-login">
                        @foreach (var login in AutocompleteLogins)
                        {
                            <option>@login</option>
                        }
                    </datalist>
                </div>
                <Button OnClick="Add" Disabled="Disabled" Variant="ButtonVariant.Secondary">Add</Button>
            </div>
        </div>
    </div>

    <!-- Price Section -->
    <div class="section-box" style="margin-bottom: 1.5rem;">
        <h3 class="section-title">Gift Budget (Optional)</h3>

        @if(!_enabledPrice)
        {
            <Button OnClick="(_) => SetPriceEnabled(true)" Variant="ButtonVariant.Secondary">
                Set a recommended price limit
            </Button>
        }
        else
        {
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label class="form-label">Maximum Price</label>
                        <input type="number"
                               min="1"
                               class="input"
                               @bind-value="Price"
                               @bind-value:event="oninput"
                               placeholder="Amount"/>
                    </div>
                    <div>
                        <label class="form-label">Currency</label>
                        <input type="text"
                               class="input"
                               @bind-value="Currency"
                               @bind-value:event="oninput"
                               placeholder="e.g., USD, EUR"/>
                    </div>
                </div>
                <Button OnClick="(_) => SetPriceEnabled(false)" Variant="ButtonVariant.Secondary">
                    Remove price limit
                </Button>
            </div>
        }
    </div>

    <!-- Save -->
    <div style="display: flex; justify-content: center;">
        <Button Size="ButtonSize.Large" OnClick="Save" Disabled="!CanSave">Create Event</Button>
    </div>

    @if (!CanSave && (_members.Count > 0 || !string.IsNullOrWhiteSpace(EventName)))
    {
        <p class="text-muted" style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">
            @if (_members.Count < 1)
            {
                <span>Add at least one other participant to create the event.</span>
            }
            else if (string.IsNullOrWhiteSpace(EventName))
            {
                <span>Please enter an event name.</span>
            }
            else if (string.IsNullOrWhiteSpace(LoggedInName))
            {
                <span>Please enter your display name.</span>
            }
        </p>
    }
</div>

@code {
    private readonly List<SecretSantaMember> _members = new();
    private string? _errorText;
    private bool _enabledPrice;

    private void SetPriceEnabled(bool value) => _enabledPrice = value;

    private void RemoveMember(SecretSantaMember member) => _members.Remove(member);

    private void Add()
    {
        if (Disabled) return;

        if (_members.Any(m => m.Name.Equals(NewMemberName, StringComparison.InvariantCultureIgnoreCase)))
        {
            _errorText = "A participant with this name already exists.";
            return;
        }

        if (_members.Any(m => m.TelegramLogin.Equals(NewMemberLogin, StringComparison.InvariantCultureIgnoreCase)))
        {
            _errorText = "A participant with this Telegram username already exists.";
            return;
        }

        _members.Add(new SecretSantaMember(NewMemberName!.Trim(), NewMemberLogin!.Trim().TrimStart('@')));
        NewMemberName = null;
        NewMemberLogin = null;
        _errorText = null;
    }

    private async Task Save()
    {
        if (!CanSave) return;

        var metadataNode = JsonObject.Parse("{}")!;

        if(_enabledPrice)
        {
            metadataNode[Metadata.MaxPriceKey] = JsonSerializer.SerializeToNode(
                new MaxPrice(Price!.Value, Currency!));
        }

        var metadataDocument = JsonSerializer.SerializeToDocument(metadataNode);

        _members.Insert(0, new SecretSantaMember(LoggedInName!.Trim(), Auth.Login.Login));
        var santaEvent = SecretSantaEvent.Create(EventName!.Trim(), _members, new Metadata(metadataDocument));
        SantaEvents.AddEvent(santaEvent);
        Navigation.NavigateTo("/");

        NewMemberName = null;
        NewMemberLogin = null;
        _members.Clear();
        await Persistence.SaveEvent(santaEvent);
    }

    bool Disabled => string.IsNullOrWhiteSpace(NewMemberName) || string.IsNullOrWhiteSpace(NewMemberLogin);

    bool CanSave
    {
        get
        {
            var isValid = _members.Count >= 1 && !string.IsNullOrWhiteSpace(EventName) && !string.IsNullOrWhiteSpace(LoggedInName);
            if (_enabledPrice && (!Price.HasValue || Price < 1 || string.IsNullOrWhiteSpace(Currency)))
                isValid = false;
            return isValid;
        }
    }

    public string? NewMemberName { get; set; }
    public string? NewMemberLogin { get; set; }
    public string? EventName { get; set; }
    public string? LoggedInName { get; set; }
    public int? Price { get; set; }
    public string? Currency { get; set; }

    private async Task UpdateAutocomplete(ChangeEventArgs eventArgs)
    {
        AutocompleteLogins = await Persistence.GetAutocompleteFor(Auth.Login.Login, eventArgs.Value as string);
        StateHasChanged();
    }

    public string[] AutocompleteLogins { get; set; } = Array.Empty<string>();
}
