@page "/{Uid}/selected"

@using SecretSanta.Domain.Data
@using SecretSanta.Domain.State
@using SecretSanta.Domain
@using System.Diagnostics.CodeAnalysis
@inject Persistence Persistence
@inject UserSantaEvents SantaEvents
@inject TelegramAuth TelegramAuth
@inject NavigationManager Navigation
@inject IJSRuntime Js

<div class="animate-in">
    <h2 class="page-title">@Name</h2>

    <!-- Share Link -->
    <div class="section-box" style="margin-bottom: 1.5rem;">
        <h3 class="section-title">Share with Participants</h3>
        <p class="text-muted" style="margin-bottom: 1rem;">
            Share this link with other members - they'll be able to see who they need to buy a gift for!
        </p>

        <div class="copy-box" @onclick="CopyToClipboard">
            @OpponentUrl
        </div>

        @if (_copied)
        {
            <p class="text-success" style="margin-top: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>‚úì</span> Copied to clipboard!
            </p>
        }

        <div style="margin-top: 1rem;">
            <Button OnClick="GoToOpponent">See Your Match</Button>
        </div>
    </div>

    <!-- Participants -->
    <div class="section-box" style="margin-bottom: 1.5rem;">
        <h3 class="section-title">Participants (@Members.Count())</h3>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;">
            @foreach (var (name, telegramLogin) in Members)
            {
                <div class="member-card">
                    <p class="member-name">@name</p>
                    <a class="member-username" target="_blank" href="https://t.me/@telegramLogin">
                        @@@telegramLogin
                    </a>
                </div>
            }
        </div>
    </div>

    <!-- Price -->
    @if(TryGetPrice(out var price))
    {
        <div class="section-box" style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 2rem;">üéÅ</span>
            <div>
                <p class="text-muted" style="font-size: 0.875rem; margin: 0;">Recommended max price</p>
                <p style="font-size: 1.25rem; font-weight: 700; margin: 0;">@price.Value @price.Currency</p>
            </div>
        </div>
    }

    <!-- Owner Controls -->
    @if(IsOwner)
    {
        <div class="section-box">
            <h3 class="section-title">Event Settings</h3>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
                <input type="checkbox"
                       style="width: 1.25rem; height: 1.25rem; accent-color: var(--color-red);"
                       @onchange="(args) => SetArchived(args)"
                       checked=@Selected.Archived />
                <span>Archive this event</span>
            </label>
            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">
                Archived events are marked as completed and moved to the bottom of your list.
            </p>
        </div>
    }
</div>

@code {

    [Parameter]
    public string Uid { get; set; }

    private bool _copied;

    private IEnumerable<SecretSantaMember> Members => Selected?.TelegramUsers ?? Array.Empty<SecretSantaMember>();

    private bool IsOwner => Selected?.IsOwner(TelegramAuth.Login.Login) ?? false;

    private SecretSantaEvent Selected { get; set; }

    private bool TryGetPrice([NotNullWhen(true)] out MaxPrice? price)
    {
        price = null;
        return Selected?.Metadata.TryGetPrice(out price) ?? false;
    }

    private async Task SetArchived(ChangeEventArgs args)
    {
        var archived = (bool)args.Value;
        Selected.SetArchived(archived);
        await Persistence.SaveArchived(Selected);
    }

    protected override void OnParametersSet()
    {
        Selected = SantaEvents.Events.FirstOrDefault(e => e.Uid == Uid);
        if (Selected == null)
        {
            Navigation.NavigateTo("/");
        }
        base.OnParametersSet();
    }

    private string RelativeOpponentUrl => $"/{Uid}/WhoAmISecretSantaFor";
    private string OpponentUrl => Navigation.ToAbsoluteUri(RelativeOpponentUrl).ToString();
    private string Name => Selected?.Name ?? string.Empty;

    private async Task CopyToClipboard()
    {
        await Js.InvokeVoidAsync("navigator.clipboard.writeText", OpponentUrl);
        _copied = true;
    }

    private void GoToOpponent()
    {
        Navigation.NavigateTo(RelativeOpponentUrl);
    }
}
